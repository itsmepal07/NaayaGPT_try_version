import faiss
import numpy as np
import json
from groq import Groq
from sentence_transformers import SentenceTransformer
import os
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()
client = Groq(api_key=os.environ.get("GROQ_API_KEY"))
# 1. Load saved FAISS + docs
# =========================
embeddings = np.load("embeddings (1) (1).npy")
with open("docs (1).json", "r", encoding="utf-8") as f:
    docs = json.load(f)

dimension = embeddings.shape[1]
index = faiss.IndexFlatL2(dimension)
index.add(embeddings)

print(f"üîç Loaded FAISS index with {index.ntotal} chunks.")

# 2. Groq Inference

def groq_infer(question, context=None):
    messages = [
        {"role": "system", "content": "You are a legal assistant trained to answer questions only in the domain of law.You will reply with accurate and concise legal information based on the provided context and also include ipc sections bns sections and help line numbers wherever applicable.also include step by step procedure for filing case sor fIRs wherever applicable."},
        "If the user's question is not related to legal topics, politely respond: "
        "'I'm sorry, I can only assist with legal questions.'"}
    ]

    if context:
        messages.append({"role": "system", "content": f"Context:\n{context}"})

    messages.append({"role": "user", "content": question})

    response = client.chat.completions.create(
        model="llama-3.3-70b-versatile",  # updated supported model
        messages=messages,
        temperature=0,  # deterministic answers for legal queries
        max_tokens=512
    )

    # Access the message correctly
    return response.choices[0].message.content


# 4. RAG Query Function
# =========================
model = SentenceTransformer('all-MiniLM-L6-v2')  # for query embeddings

def rag_query(question, k=3):
    q_emb = model.encode([question])
    D, I = index.search(np.array(q_emb), k)

    context = "\n\n".join([docs[idx] for idx in I[0]])
    return groq_infer(question, context)

# 5. Example Usage
# =========================
# query = "What are the rights of SC/ST in elections?"
query = input("enter query : ")
answer = rag_query(query, k=3)

print("Q:", query)
print("Answer:", answer)